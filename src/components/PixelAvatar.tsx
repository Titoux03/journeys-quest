import React, { useMemo } from 'react';
import { motion } from 'framer-motion';
import { useLevel } from '@/hooks/useLevel';
import { useAuth } from '@/hooks/useAuth';

export type AvatarGender = 'male' | 'female';

interface PixelAvatarProps {
  size?: 'sm' | 'md' | 'lg';
  onClick?: () => void;
  className?: string;
  level?: number;
  gender?: AvatarGender;
  equippedOverlays?: { slot: string; pixelData: number[][]; palette: string[] }[];
}

// ── Male base sprites per evolution ────────────────────────────
const MALE_STAGES: { minLevel: number; name: string; pixels: number[][]; palette: string[] }[] = [
  {
    minLevel: 0,
    name: 'Initié',
    palette: ['', '#C8A882', '#A68060', '#3B5998', '#2C4270', '#FFFFFF', '#2A1A0E', '#5A7EC0', '#FFE066'],
    pixels: [
      [0,0,0,0,6,6,6,6,0,0,0,0],
      [0,0,0,6,6,6,6,6,6,0,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,1,1,2,2,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,1,2,2,1,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,3,3,3,4,3,3,4,3,3,3,0],
      [0,3,3,3,4,3,3,4,3,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,0,0,3,3,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 10,
    name: 'Voyageur',
    palette: ['', '#C8A882', '#A68060', '#2E5090', '#1D3A6E', '#FFFFFF', '#1A1208', '#5A8AC0', '#FFE066', '#B8860B'],
    pixels: [
      [0,0,0,0,6,6,6,6,0,0,0,0],
      [0,0,0,6,6,6,6,6,6,0,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,1,1,2,2,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,1,2,2,1,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [0,9,3,3,3,3,3,3,3,3,9,0],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [3,3,3,3,4,3,3,4,3,3,3,3],
      [0,3,3,3,4,3,3,4,3,3,3,0],
      [0,0,3,9,3,3,3,3,9,3,0,0],
      [0,0,0,3,3,0,0,3,3,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 25,
    name: 'Guerrier',
    palette: ['', '#C8A882', '#A68060', '#4A4A8A', '#2E2E6E', '#FF6B35', '#1A1208', '#6A6AAA', '#FFE066', '#B8860B', '#CC3333'],
    pixels: [
      [0,0,0,0,6,6,6,6,0,0,0,0],
      [0,0,0,9,6,6,6,6,9,0,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,5,1,2,2,1,5,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [10,0,0,0,1,2,2,1,0,0,0,10],
      [10,0,0,0,0,1,1,0,0,0,0,10],
      [10,9,3,3,9,3,3,9,3,3,9,10],
      [10,3,3,3,4,9,9,4,3,3,3,10],
      [0,3,3,3,4,3,3,4,3,3,3,0],
      [0,3,3,9,3,3,3,3,9,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,0,0,3,3,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 50,
    name: 'Maître',
    palette: ['', '#D0D0E8', '#A0A0D0', '#6030A0', '#401880', '#00FFFF', '#301060', '#8050C0', '#FFD700', '#FFD700', '#FF00FF', '#00DDFF'],
    pixels: [
      [0,0,0,8,9,8,9,8,9,0,0,0],
      [0,0,9,8,9,8,9,8,9,8,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [11,0,1,1,1,1,1,1,1,1,0,11],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,5,1,2,2,1,5,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [11,0,0,0,1,2,2,1,0,0,0,11],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [11,9,3,3,9,3,3,9,3,3,9,11],
      [11,3,3,3,4,9,9,4,3,3,3,11],
      [11,3,3,3,4,3,3,4,3,3,3,11],
      [0,3,3,9,3,3,3,3,9,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,0,0,3,3,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 100,
    name: 'Légende',
    palette: ['', '#E8E0FF', '#C0B0FF', '#2020AA', '#1010CC', '#FFFF00', '#100880', '#6060DD', '#FFD700', '#FF8C00', '#FF00FF', '#00FFFF'],
    pixels: [
      [11,0,0,8,9,8,9,8,9,0,0,11],
      [0,11,9,8,9,8,9,8,9,8,11,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [10,0,6,6,6,6,6,6,6,6,0,10],
      [10,0,1,1,1,1,1,1,1,1,0,10],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,5,1,2,2,1,5,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [10,0,9,0,1,2,2,1,0,9,0,10],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [10,9,3,3,9,3,3,9,3,3,9,10],
      [10,3,3,3,4,9,9,4,3,3,3,10],
      [11,3,3,3,4,3,3,4,3,3,3,11],
      [0,3,3,9,3,3,3,3,9,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,0,0,3,3,0,0,0],
      [0,0,11,4,4,0,0,4,4,11,0,0],
    ],
  },
];

// ── Female base sprites per evolution ────────────────────────────
const FEMALE_STAGES: { minLevel: number; name: string; pixels: number[][]; palette: string[] }[] = [
  {
    minLevel: 0,
    name: 'Initiée',
    palette: ['', '#D4A984', '#B88A66', '#C25B78', '#9B3A58', '#FFFFFF', '#3D1A0A', '#D88CA0', '#FFE066'],
    pixels: [
      [0,0,0,6,6,6,6,6,6,0,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,1,1,2,2,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,1,7,7,1,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,3,3,3,3,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 10,
    name: 'Voyageuse',
    palette: ['', '#D4A984', '#B88A66', '#2877A8', '#1D5A7E', '#FFFFFF', '#3D1A0A', '#6AB0D0', '#FFE066', '#B8860B'],
    pixels: [
      [0,0,0,6,6,6,6,6,6,0,0,0],
      [0,0,6,6,6,6,6,6,6,6,0,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,1,1,2,2,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,1,7,7,1,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [0,9,3,3,3,3,3,3,3,3,9,0],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,3,3,3,3,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 25,
    name: 'Guerrière',
    palette: ['', '#D4A984', '#B88A66', '#6A3A8A', '#4A1A6E', '#FF6BAA', '#3D1A0A', '#9A6AAA', '#FFE066', '#B8860B', '#DD55AA'],
    pixels: [
      [0,0,0,6,6,6,6,6,6,0,0,0],
      [0,0,9,6,6,6,6,6,6,9,0,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,5,1,2,2,1,5,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [10,0,0,0,1,7,7,1,0,0,0,10],
      [10,0,0,0,0,1,1,0,0,0,0,10],
      [10,9,3,3,9,3,3,9,3,3,9,10],
      [10,3,3,3,4,9,9,4,3,3,3,10],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,0,3,3,3,3,3,3,3,3,0,0],
      [0,0,0,3,3,3,3,3,3,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 50,
    name: 'Maîtresse',
    palette: ['', '#E0D0E8', '#C0A0D0', '#7030B0', '#501890', '#00FFDD', '#401060', '#9050D0', '#FFD700', '#FFD700', '#FF66CC', '#66FFEE'],
    pixels: [
      [0,0,0,8,9,8,9,8,9,0,0,0],
      [0,0,9,8,9,8,9,8,9,8,0,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [11,0,1,1,1,1,1,1,1,1,0,11],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,5,1,2,2,1,5,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [11,0,0,0,1,10,10,1,0,0,0,11],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [11,9,3,3,9,3,3,9,3,3,9,11],
      [11,3,3,3,4,9,9,4,3,3,3,11],
      [11,3,3,3,3,3,3,3,3,3,3,11],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,0,0,3,3,3,3,3,3,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,0,4,4,0,0,4,4,0,0,0],
    ],
  },
  {
    minLevel: 100,
    name: 'Légende',
    palette: ['', '#F0E0FF', '#D0B0FF', '#3020CC', '#2010DD', '#FFEE00', '#200888', '#7060EE', '#FFD700', '#FF8C00', '#FF55FF', '#55FFFF'],
    pixels: [
      [11,0,0,8,9,8,9,8,9,0,0,11],
      [0,11,9,8,9,8,9,8,9,8,11,0],
      [0,6,6,6,6,6,6,6,6,6,6,0],
      [10,6,6,6,6,6,6,6,6,6,6,10],
      [10,0,1,1,1,1,1,1,1,1,0,10],
      [0,0,1,5,1,1,1,1,5,1,0,0],
      [0,0,1,5,1,2,2,1,5,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
      [10,0,9,0,1,10,10,1,0,9,0,10],
      [0,0,0,0,0,1,1,0,0,0,0,0],
      [10,9,3,3,9,3,3,9,3,3,9,10],
      [10,3,3,3,4,9,9,4,3,3,3,10],
      [11,3,3,3,3,3,3,3,3,3,3,11],
      [0,3,3,3,3,3,3,3,3,3,3,0],
      [0,0,0,3,3,3,3,3,3,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,11,4,4,0,0,4,4,11,0,0],
    ],
  },
];

// ── Pixel art overlay data for equipped items ─────────────────
// Each overlay is a sparse layer rendered on top of the base sprite
export const ITEM_PIXEL_OVERLAYS: Record<string, { pixels: number[][]; palette: string[] }> = {
  // Heads
  crown_gold: {
    palette: ['', '#FFD700', '#FFA500', '#FFFFFF'],
    pixels: [
      [0,0,1,2,1,0,0,1,2,1,0,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
    ],
  },
  crown_diamond: {
    palette: ['', '#88DDFF', '#55AAFF', '#FFFFFF', '#AAEEFF'],
    pixels: [
      [0,0,1,3,1,4,4,1,3,1,0,0],
      [0,0,1,1,2,1,1,2,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,0,0,0],
    ],
  },
  helmet_warrior: {
    palette: ['', '#666666', '#888888', '#AAAAAA', '#FF4444'],
    pixels: [
      [0,0,0,0,0,4,4,0,0,0,0,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,2,3,2,2,3,2,1,0,0],
      [0,0,1,1,1,1,1,1,1,1,0,0],
    ],
  },
  halo_light: {
    palette: ['', '#FFE88866', '#FFD70066', '#FFFFFF44'],
    pixels: [
      [0,0,0,1,2,3,3,2,1,0,0,0],
      [0,0,1,0,0,0,0,0,0,1,0,0],
    ],
  },
  // Capes
  cape_red: {
    palette: ['', '#CC2222', '#991111', '#FF4444'],
    pixels: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [1,3,0,0,0,0,0,0,0,0,3,1],
      [2,1,0,0,0,0,0,0,0,0,1,2],
      [2,1,3,0,0,0,0,0,0,3,1,2],
      [0,2,1,0,0,0,0,0,0,1,2,0],
      [0,0,2,1,0,0,0,0,1,2,0,0],
      [0,0,0,2,0,0,0,0,2,0,0,0],
    ],
  },
  cape_royal: {
    palette: ['', '#6030A0', '#401880', '#FFD700'],
    pixels: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [1,3,0,0,0,0,0,0,0,0,3,1],
      [2,1,0,0,0,0,0,0,0,0,1,2],
      [2,1,3,0,0,0,0,0,0,3,1,2],
      [0,2,1,3,0,0,0,0,3,1,2,0],
      [0,0,2,1,0,0,0,0,1,2,0,0],
      [0,0,0,2,3,0,0,3,2,0,0,0],
    ],
  },
  // Weapons
  sword_basic: {
    palette: ['', '#AAAAAA', '#888888', '#CCCCCC', '#8B4513'],
    pixels: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0,3,0],
      [0,0,0,0,0,0,0,0,0,3,0,0],
      [0,0,0,0,0,0,0,0,3,0,0,0],
      [0,0,0,0,0,0,0,1,0,0,0,0],
      [0,0,0,0,0,0,1,0,0,0,0,0],
      [0,0,0,0,0,1,0,0,0,0,0,0],
      [0,0,0,0,2,0,0,0,0,0,0,0],
      [0,0,0,4,2,4,0,0,0,0,0,0],
      [0,0,0,0,4,0,0,0,0,0,0,0],
      [0,0,0,0,4,0,0,0,0,0,0,0],
    ],
  },
  staff_magic: {
    palette: ['', '#8B4513', '#A0522D', '#FF00FF', '#FFD700'],
    pixels: [
      [0,0,0,0,0,0,0,0,0,0,0,3],
      [0,0,0,0,0,0,0,0,0,0,3,4],
      [0,0,0,0,0,0,0,0,0,3,4,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,2,0,0],
      [0,0,0,0,0,0,0,0,2,0,0,0],
      [0,0,0,0,0,0,0,1,0,0,0,0],
      [0,0,0,0,0,0,1,0,0,0,0,0],
      [0,0,0,0,0,1,0,0,0,0,0,0],
      [0,0,0,0,1,0,0,0,0,0,0,0],
      [0,0,0,1,0,0,0,0,0,0,0,0],
      [0,0,1,0,0,0,0,0,0,0,0,0],
    ],
  },
  // Auras
  aura_fire: {
    palette: ['', '#FF440033', '#FF880033', '#FFCC0033'],
    pixels: [
      [0,0,0,0,3,0,0,3,0,0,0,0],
      [0,0,0,3,2,0,0,2,3,0,0,0],
      [0,0,3,2,0,0,0,0,2,3,0,0],
      [0,3,2,0,0,0,0,0,0,2,3,0],
      [3,2,1,0,0,0,0,0,0,1,2,3],
      [2,1,0,0,0,0,0,0,0,0,1,2],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,1],
      [2,0,0,0,0,0,0,0,0,0,0,2],
      [2,1,0,0,0,0,0,0,0,0,1,2],
      [3,2,0,0,0,0,0,0,0,0,2,3],
      [0,3,2,0,0,0,0,0,0,2,3,0],
      [0,0,3,2,0,0,0,0,2,3,0,0],
      [0,0,0,3,2,1,1,2,3,0,0,0],
    ],
  },
  // Pets
  pet_cat: {
    palette: ['', '#FF8800', '#CC6600', '#FFFFFF', '#000000'],
    pixels: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,1,0,1],
      [0,0,0,0,0,0,0,0,0,1,1,1],
      [0,0,0,0,0,0,0,0,0,4,3,4],
      [0,0,0,0,0,0,0,0,2,1,1,1],
    ],
  },
  pet_dragon: {
    palette: ['', '#44AA44', '#228822', '#FFDD00', '#FF4400'],
    pixels: [
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,4,0],
      [0,0,0,0,0,0,0,0,0,4,0,0],
      [0,0,0,0,0,0,0,0,1,2,1,0],
      [0,0,0,0,0,0,0,0,1,3,1,0],
      [0,0,0,0,0,0,0,1,1,1,1,0],
      [0,0,0,0,0,0,0,2,0,0,2,0],
    ],
  },
};

const SIZE_CONFIG = {
  sm: { pixelSize: 3, containerClass: 'w-14 h-14' },
  md: { pixelSize: 5, containerClass: 'w-24 h-24' },
  lg: { pixelSize: 7, containerClass: 'w-36 h-40' },
};

export const PixelAvatar: React.FC<PixelAvatarProps> = ({
  size = 'md',
  onClick,
  className = '',
  level: levelProp,
  gender = 'male',
  equippedOverlays = [],
}) => {
  const { user } = useAuth();
  const { levelData } = useLevel(user?.id);

  const currentLevel = levelProp ?? levelData?.level ?? 1;
  const config = SIZE_CONFIG[size];
  const stages = gender === 'female' ? FEMALE_STAGES : MALE_STAGES;

  const stage = useMemo(() => {
    const sorted = [...stages].sort((a, b) => b.minLevel - a.minLevel);
    return sorted.find(s => currentLevel >= s.minLevel) || stages[0];
  }, [currentLevel, stages]);

  const COLS = stage.pixels[0]?.length || 12;
  const ROWS = stage.pixels.length;
  const isLegendary = currentLevel >= 100;
  const isMaster = currentLevel >= 50;

  // Merge overlays on top of base
  const mergedPixels = useMemo(() => {
    // Start with base
    const base = stage.pixels.map(row => [...row]);
    // We'll return an array of { color: string } for each cell
    const result: (string | null)[][] = base.map(row =>
      row.map(idx => (idx === 0 ? null : stage.palette[idx] || null))
    );

    // Apply each equipped overlay
    for (const overlay of equippedOverlays) {
      const { pixelData: oPixels, palette: oPalette } = overlay;
      for (let r = 0; r < Math.min(oPixels.length, ROWS); r++) {
        for (let c = 0; c < Math.min(oPixels[r].length, COLS); c++) {
          const idx = oPixels[r][c];
          if (idx !== 0 && oPalette[idx]) {
            result[r][c] = oPalette[idx];
          }
        }
      }
    }
    return result;
  }, [stage, equippedOverlays, ROWS, COLS]);

  return (
    <motion.div
      className={`relative cursor-pointer group flex items-center justify-center ${className}`}
      onClick={onClick}
      whileHover={{ scale: 1.08 }}
      whileTap={{ scale: 0.95 }}
    >
      {/* Aura glow */}
      {isMaster && (
        <motion.div
          className="absolute rounded-full"
          style={{
            width: config.pixelSize * COLS + 20,
            height: config.pixelSize * ROWS + 20,
            background: isLegendary
              ? 'radial-gradient(circle, hsl(280 100% 70% / 0.3), hsl(200 100% 60% / 0.1), transparent)'
              : 'radial-gradient(circle, hsl(45 100% 65% / 0.2), transparent)',
            filter: 'blur(8px)',
          }}
          animate={{ scale: [1, 1.15, 1], opacity: [0.6, 1, 0.6] }}
          transition={{ duration: 2, repeat: Infinity, ease: 'easeInOut' }}
        />
      )}

      {/* Pixel grid */}
      <div
        className="relative"
        style={{
          display: 'grid',
          gridTemplateColumns: `repeat(${COLS}, ${config.pixelSize}px)`,
          gridTemplateRows: `repeat(${ROWS}, ${config.pixelSize}px)`,
          imageRendering: 'pixelated',
        }}
      >
        {mergedPixels.flat().map((color, i) => {
          if (!color) {
            return <div key={i} style={{ width: config.pixelSize, height: config.pixelSize }} />;
          }
          return (
            <motion.div
              key={i}
              style={{
                width: config.pixelSize,
                height: config.pixelSize,
                backgroundColor: color,
              }}
              initial={{ opacity: 0, scale: 0 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{
                delay: (i % COLS) * 0.008 + Math.floor(i / COLS) * 0.015,
                duration: 0.12,
              }}
            />
          );
        })}
      </div>

      {/* Floating particles for legendary */}
      {isLegendary && (
        <>
          {[0, 1, 2].map(i => (
            <motion.div
              key={`p-${i}`}
              className="absolute w-1 h-1 rounded-full"
              style={{
                backgroundColor: ['#FFD700', '#FF00FF', '#00FFFF'][i],
                left: `${20 + i * 30}%`,
                bottom: '20%',
              }}
              animate={{ y: [-20, -50, -20], opacity: [0, 1, 0], x: [0, (i - 1) * 10, 0] }}
              transition={{ duration: 2 + i * 0.5, repeat: Infinity, delay: i * 0.7 }}
            />
          ))}
        </>
      )}

      {/* Idle breathing */}
      <motion.div
        className="absolute inset-0 pointer-events-none"
        animate={{ y: [0, -2, 0] }}
        transition={{ duration: 3, repeat: Infinity, ease: 'easeInOut' }}
      />
    </motion.div>
  );
};
